name: Backend CI/CD with Portainer Deploy
on:
  workflow_call:
    inputs:
      ENVIRONMENT:
        description: "Deployment environment (dev/prod)"
        required: true
        type: string
      REGISTRY_URL:
        description: "Docker registry URL"
        required: true
        type: string
      REGISTRY_PATH:
        description: "Docker image path"
        required: true
        type: string
      REGISTRY_USERNAME:
        description: "Username for Docker registry"
        required: true
        type: string
      REGISTRY_PASSWORD:
        description: "Password for Docker registry"
        required: true
        type: string
      REGISTRY_TAG:
        description: "Tag for Docker image"
        required: true
        type: string
      PORTAINER_STAGE_WEBHOOK:
        description: "Webhook URL for Portainer deployment"
        required: true
        type: string
      FRONT_URL:
        description: "Url to frontend"
        required: true
        type: string
      RUN_SERVICE_FOR_TESTS:
        required: true
        default: true
        type: boolean
      SKIP_DEPLOY:
        description: "Set to true to skip Docker build/push and Portainer deploy"
        required: false
        default: false
        type: boolean
    secrets:
      INTERNSHIP_API_KEY:
        required: true
      ADZUNA_APP_ID:
        required: true
      ADZUNA_APP_KEY:
        required: true
      NEWSAPI_API_KEY:
        required: true
      DB_HOST:
        required: true
      DB_PORT:
        required: true
      POSTGRES_USER:
        required: true
      POSTGRES_PASSWORD:
        required: true
      POSTGRES_DB:
        required: true

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2

      - name: Build with Maven
        run: ./mvnw clean package -DskipTests

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: build
    defaults:
      run:
        working-directory: ./backend
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      - name: Check for commented-out code
        run: |
          echo "Check for commented-out code"
          
          if grep -RIn --include="*.java" -E "^\s*//\s*(class |interface |void |public |private |protected |return |import |package )" .; then
            echo "Commented-out code found"
            exit 1
          else
            echo "Commented-out code do not found"
          fi
      - name: Run Checkstyle (Google Style)
        run: ./mvnw checkstyle:check
      - name: Run PMD
        run: ./mvnw pmd:check

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build
    defaults:
      run:
        working-directory: ./backend
    env:
      INTERNSHIP_API_KEY: ${{ secrets.INTERNSHIP_API_KEY }}
      ADZUNA_APP_ID: ${{ secrets.ADZUNA_APP_ID }}
      ADZUNA_APP_KEY: ${{ secrets.ADZUNA_APP_KEY }}
      NEWSAPI_API_KEY: ${{ secrets.NEWSAPI_API_KEY }}
      DB_HOST: localhost
      DB_PORT: ${{ secrets.DB_PORT }}
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2
      - name: Debug environment
        run: env | grep -E 'INTERNSHIP|ADZUNA|JOOBLE'
      - name: Run unit tests
        run: ./mvnw test -Dgroups=unit
      - name: Run Spring Boot app in background with healthcheck
        if: ${{ inputs.RUN_SERVICE_FOR_TESTS == 'true' }}
        run: |
          ./mvnw spring-boot:run > app.log 2>&1 &
          APP_PID=$!
          echo $APP_PID > app_pid.txt
          echo "Waiting for API to start..."
          MAX_RETRIES=20
          RETRY_INTERVAL=5
          for i in $(seq 1 $MAX_RETRIES); do
            if curl -s http://localhost:8080/actuator/health | grep '"status":"UP"' > /dev/null; then
              echo "API is up!"
              break
            fi
            echo "Waiting... ($i/$MAX_RETRIES)"
            sleep $RETRY_INTERVAL
          done
          if ! curl -s http://localhost:8080/actuator/health | grep '"status":"UP"' > /dev/null; then
            echo "API did not start in time"
            cat app.log
            kill $APP_PID
            exit 1
          fi
      - name: Run Integration Tests
        run: ./mvnw verify -Dgroups=integration
      - name: Stop Spring Boot app
        run: |
          if [ -f app_pid.txt ]; then
            kill $(cat app_pid.txt)
          else
            echo "app_pid.txt not found, nothing to kill"
          fi
          
  docker:
    name: Docker Build, Push & Deploy
    runs-on: ubuntu-latest
    needs: [test, lint]
    if: ${{ inputs.SKIP_DEPLOY == false }}
    defaults:
      run:
        working-directory: ./backend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Docker login
        run: echo "${{ inputs.REGISTRY_PASSWORD }}" | docker login ${{ inputs.REGISTRY_URL }} -u ${{ inputs.REGISTRY_USERNAME }} --password-stdin

      - name: Build Docker image
        run: |
          docker build \
            -t ${{ inputs.REGISTRY_URL }}/${{ inputs.REGISTRY_PATH }}:${{ inputs.REGISTRY_TAG }} \
            --build-arg ENVIRONMENT=${{ inputs.ENVIRONMENT }} .

      - name: Push Docker image
        run: docker push ${{ inputs.REGISTRY_URL }}/${{ inputs.REGISTRY_PATH }}:${{ inputs.REGISTRY_TAG }}

      - name: Trigger Portainer Webhook with retry
        run: |
          MAX_RETRIES=5
          RETRY_INTERVAL=10
          for i in $(seq 1 $MAX_RETRIES); do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST "${{ inputs.PORTAINER_STAGE_WEBHOOK }}?REGISTRY_TAG=${{ inputs.REGISTRY_TAG }}")
            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              echo "Webhook triggered successfully (HTTP $HTTP_CODE)"
              break
            fi
            echo "Webhook failed with HTTP $HTTP_CODE. Retrying ($i/$MAX_RETRIES)..."
            sleep $RETRY_INTERVAL
            if [ "$i" -eq $MAX_RETRIES ]; then
              echo "Failed to trigger webhook after $MAX_RETRIES attempts"
              exit 1
            fi
          done

      - name: Cleanup local Docker image
        run: docker rmi ${{ inputs.REGISTRY_URL }}/${{ inputs.REGISTRY_PATH }}:${{ inputs.REGISTRY_TAG }} || true
